{% extends "base.html" %}
{% load static %}

{% block header %}
<style>
#table_list_projects tbody tr.selected td {background-color:#B0BED9}
#table_list_projects tbody tr.odd.selected td {background-color:#acbad4}
.scrollable-panel {
    max-height: 300px;
    overflow-y: auto;
}
.keyword-editor-list {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e5e5e5;
    border-radius: 4px;
    padding: 10px;
    background: #fafafa;
}
.keyword-editor-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 0;
    border-bottom: 1px solid #eee;
}
.keyword-editor-row:last-child {
    border-bottom: none;
}
.keyword-editor-row input[type="text"] {
    flex: 2;
}
.keyword-editor-row select {
    flex: 1;
}
.keyword-editor-row .btn-remove {
    color: #c9302c;
    cursor: pointer;
    padding: 4px 8px;
}
.keyword-editor-row .btn-remove:hover {
    background: #f8d7da;
    border-radius: 3px;
}
.keyword-editor-row.disabled-keyword {
    opacity: 0.6;
    background: #f5f5f5;
}
.new-keyword-row {
    background: #e8f5e9;
}
</style>
{% endblock %}

{% block content %}
{% spaceless %}
<div class="page-header">
    <div class="media">
        <div class="media-left">
        </div>
        <div class="media-body">
            <h2 class="media-heading">üóùÔ∏è Keywords</h2>
        </div>
    </div>
</div>

{% if messages %}{% for message in messages %}<div {% if message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>{{ message }}</div>{% endfor %}{% endif %}

<div class="container-fluid" style="padding-left:0; padding-right:0;">
  <div class="row">
    <div class="col-md-6">
      <div class="panel panel-default">
        <div class="panel-heading">// General Actions</div>
        <div class="panel-body">
            <button type="button" class="btn btn-primary btn-xs" id="btn-manage-keywords">Manage Keywords</button>&nbsp;
            <button type="button" class="btn btn-primary btn-xs" data-toggle="modal" data-target="#ScanKeywordsModal">Scan keywords</button>&nbsp;
            <button type="button" class="btn btn-primary btn-xs" data-toggle="modal" data-target="#UploadRansomlookSuppliersModal">Upload RansomLook Suppliers</button>&nbsp;
        </div>
      </div>
    </div>
  </div>
</div>


<div class="panel panel-default">
  <div class="panel-heading">
    // Keywords
  </div>
  <div class="panel-body">
    <table id="table_list_keywords" class="table table-condensed table-striped table-bordered" style="font-size: 0.9em;">
    <thead>
        <th>Keyword</th>
        <th>Type</th>
        <th>Enabled</th>
        <th>Description</th>
        <th>Created</th>
        <th>Operations</th>
    </thead>
    </table>
    </div>
</div>

<div class="panel panel-default">
  <div class="panel-heading">
    // Suppliers
  </div>
  <div class="panel-body">
    <table id="table_suppliers" class="table table-condensed table-striped table-bordered" style="font-size: 0.9em;">
    <thead>
        <th>Supplier</th>
        <th>Enabled</th>
        <th>Description</th>
        <th>Created</th>
        <th>Operations</th>
    </thead>
    </table>
  </div>
</div>

<!-- New Panel for Interesting Keywords -->
<div class="panel panel-default">
  <div class="panel-heading">
    // Interesting potential Keywords
  </div>
  <div class="panel-body scrollable-panel">
    <ul id="interesting-keywords-list">
      {% for description in descriptions %}
        <li>{{ description }}</li>
      {% endfor %}
    </ul>
  </div>
</div>

<!-- Manage Keywords Modal -->
<div class="modal fade" id="ManageKeywordsModal" tabindex="-1" role="dialog" aria-labelledby="manageKeywordsModal">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4>Manage Keywords</h4>
        </div>
        <div class="modal-body">
            <p class="text-muted">Add, edit, or remove keywords. Changes are saved when you click "Save Changes".</p>
            
            <div class="keyword-editor-list" id="keyword-editor-list">
                <!-- Keywords will be loaded here dynamically -->
                <div class="text-center text-muted" id="keywords-loading">Loading keywords...</div>
            </div>
            
            <div style="margin-top: 12px;">
                <button type="button" class="btn btn-success btn-sm" id="btn-add-keyword-row">
                    <span class="glyphicon glyphicon-plus"></span> Add Keyword
                </button>
            </div>
        </div>
        <div class="modal-footer">
            <span id="keywords-save-status" class="text-muted" style="margin-right: 10px;"></span>
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="btn-save-keywords">Save Changes</button>
        </div>
    </div>
  </div>
</div>

<!-- Scan Keywords Modal -->
<div class="modal fade" id="ScanKeywordsModal" tabindex="-1" role="dialog" aria-labelledby="scanKeywordsModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form action="{% url 'keywords:scan_keywords' %}" method="post">
        <div class="modal-header">
          <h4>Scan Keywords</h4>
        </div>
        <div class="modal-body">
          {% csrf_token %}

          <div class="form-group">
            <div class="form-check d-flex align-items-center" style="gap: 8px;">
              <input type="checkbox" class="form-check-input" id="scankeywords_domaintools" name="domaintools" >
              <label class="form-check-label mb-0" for="scankeywords_domaintools" style="margin-bottom:0; margin-left:6px;">
                DomainTools
              </label>
            </div>
          </div>

          <div class="form-group">
            <div class="form-check d-flex align-items-center" style="gap: 8px;">
              <input type="checkbox" class="form-check-input" id="scankeywords_crtsh" name="crtsh" >
              <label class="form-check-label mb-0" for="scankeywords_crtsh" style="margin-bottom:0; margin-left:6px;">
                Crt.sh
              </label>
            </div>
          </div>

          <div class="form-group">
            <div class="form-check d-flex align-items-center" style="gap: 8px;">
              <input type="checkbox" class="form-check-input" id="scankeywords_shodan" name="shodan" >
              <label class="form-check-label mb-0" for="scankeywords_shodan" style="margin-bottom:0; margin-left:6px;">
                Shodan
              </label>
            </div>
          </div>

          <div class="form-group">
            <div class="form-check d-flex align-items-center" style="gap: 8px;">
              <input type="checkbox" class="form-check-input" id="scankeywords_porch-pirate" name="porch-pirate" >
              <label class="form-check-label mb-0" for="scankeywords_porch-pirate" style="margin-bottom:0; margin-left:6px;">
                Porch-pirate - Data leakage
              </label>
            </div>
          </div>

          <div class="form-group">
            <div class="form-check d-flex align-items-center" style="gap: 8px;">
              <input type="checkbox" class="form-check-input" id="scankeywords_swaggerhub" name="swaggerhub" >
              <label class="form-check-label mb-0" for="scankeywords_swaggerhub" style="margin-bottom:0; margin-left:6px;">
                SwaggerHub - Data leakage
              </label>
            </div>
          </div>

          <div class="form-group">
            <div class="form-check d-flex align-items-center" style="gap: 8px;">
              <input type="checkbox" class="form-check-input" id="scankeywords_ai_scribd" name="ai_scribd" >
              <label class="form-check-label mb-0" for="scankeywords_ai_scribd" style="margin-bottom:0; margin-left:6px;">
                ShepherdAI and Scribd - Data leakage
              </label>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Run</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Upload RansomLook Suppliers Modal -->
<div class="modal fade" id="UploadRansomlookSuppliersModal" tabindex="-1" role="dialog" aria-labelledby="uploadRansomlookSuppliersModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="upload-ransomlook-suppliers-form" action="{% url 'keywords:upload_ransomlook_suppliers' %}" method="post" enctype="multipart/form-data">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4>Upload RansomLook Suppliers</h4>
        </div>
        <div class="modal-body">
          {% csrf_token %}
          <p class="text-muted" style="margin-bottom: 12px;">Upload a text file with one supplier per line.</p>
          
          <div id="upload-suppliers-drop-zone" style="border: 2px dashed #ccc; border-radius: 6px; padding: 30px 20px; text-align: center; cursor: pointer; transition: all 0.2s ease; background: #fafafa;">
            <span class="glyphicon glyphicon-cloud-upload" style="font-size: 32px; color: #999; display: block; margin-bottom: 10px;"></span>
            <span id="upload-suppliers-drop-text" style="color: #666;">Drag & drop a .txt file here<br><small>or click to browse</small></span>
            <input type="file" id="modal-suppliers-file" name="suppliers_file" accept=".txt" style="display: none;">
          </div>
          
          <div id="upload-suppliers-file-info" style="display: none; margin-top: 12px; padding: 10px; background: #e8f5e9; border-radius: 4px;">
            <span class="glyphicon glyphicon-file" style="color: #4caf50;"></span>
            <span id="upload-suppliers-file-name" style="margin-left: 6px; font-weight: 500;"></span>
            <button type="button" id="upload-suppliers-clear-file" class="btn btn-xs btn-link" style="float: right; color: #c9302c;">Remove</button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="upload-suppliers-submit-btn" disabled>Upload</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endspaceless%}
{% endblock %}

{% block javascript %}
<script src="{% static 'js/bootbox.min.js' %}"></script>
<script type="text/javascript" language="javascript" class="init">
$(document).ready( function () {
    var keywordsTable = $('#table_list_keywords').DataTable({
        processing: true, serverSide: true, pageLength: 25, select: true,
        oLanguage: { sProcessing: "<img src='{% static 'img/loading.gif' %}'>", },
        order: [[ 1, "asc" ]], // Sort by Type (column index 1)
        ajax: {
            processing: true,
            url: "/api/v1/project/{{ projectid }}/keywords/all/",
            dataSrc: "results",
            type: "GET",
            dataType: "json"
        },
        columns: [
            {'data': 'keyword', 'sName': 'Keyword', 'aTargets': [ 0 ],
                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                    $("div", nTd).tooltip();
                },
            },
            {'data': 'ktype', 'sName': 'Type', 'aTargets': [ 1 ]},
            {'data': 'enabled', 'sName': 'Enabled', 'aTargets': [ 2 ],
                "mRender": function (data, type, full) {
                    var toggle_url = "{% url 'keywords:toggle_keyword' keywordid=0 %}".replace(0, full.id);
                    var labelClass = data ? 'label-success' : 'label-danger';
                    var tooltip = data ? 'Disable Keyword' : 'Enable Keyword';
                    return '<div rel="tooltip" data-placement="left" data-original-title="' + tooltip + '"><a href="'+toggle_url+'"><span class="label ' + labelClass + '">'+data+'</span></a></div>';
                },
            },
            {'data': 'description', 'sName': 'Description', 'aTargets': [ 3 ]},
            {'data': 'creation_time', 'sName': 'Created', 'aTargets': [ 4 ],
              'render': function(data, type, row) {
                if (!data) return '';
                if (window.moment) {
                  if (typeof data === 'string' && data.endsWith('Z')) {
                    return moment.utc(data).local().format('DD-MM-YYYY HH:mm');
                  }
                  return moment(data).format('DD-MM-YYYY HH:mm');
                }
                return data;
              }
            },
            {'data': 'id', 'sName': 'Operations', 'aTargets': [ 5 ],
                'bSortable': false,
                "mRender": function (data, type, full) {
                    var delete_url = "{% url 'keywords:delete_keyword' keywordid=0 %}".replace(0, full.id);
                    return '<div class="btn-group1">' +
                        '<a class="btn btn-xs confirm" rel="tooltip" data-placement="right" data-original-title="Delete Keyword" data-display="'+full.keyword+'" data-href="'+delete_url+'" href="#">' +
                        '<span class="glyphicon glyphicon-trash" aria-hidden="true"></span>' +
                        '</a> ' +
                        '</div>';
                    },
                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                    $("a", nTd).tooltip();
                }
            },
        ]
    });
    var suppliersTable = $('#table_suppliers').DataTable({
        processing: true, serverSide: true, pageLength: 25, select: true,
        oLanguage: { sProcessing: "<img src='{% static 'img/loading.gif' %}'>", },
        order: [[ 0, "asc" ]], // Sort by Supplier (column index 0)
        ajax: {
            processing: true,
            url: "/api/v1/project/{{ projectid }}/keywords/suppliers/",
            dataSrc: "results",
            type: "GET",
            dataType: "json"
        },
        columns: [
            {'data': 'keyword', 'sName': 'Supplier', 'aTargets': [ 0 ],
                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                    $("div", nTd).tooltip();
                },
            },
            {'data': 'enabled', 'sName': 'Enabled', 'aTargets': [ 1 ],
                "mRender": function (data, type, full) {
                    var toggle_url = "{% url 'keywords:toggle_keyword' keywordid=0 %}".replace(0, full.id);
                    var labelClass = data ? 'label-success' : 'label-danger';
                    var tooltip = data ? 'Disable Supplier' : 'Enable Supplier';
                    return '<div rel="tooltip" data-placement="left" data-original-title="' + tooltip + '"><a href="'+toggle_url+'"><span class="label ' + labelClass + '">'+data+'</span></a></div>';
                },
            },
            {'data': 'description', 'sName': 'Description', 'aTargets': [ 2 ]},
            {'data': 'creation_time', 'sName': 'Created', 'aTargets': [ 3 ],
              'render': function(data, type, row) {
                if (!data) return '';
                if (window.moment) {
                  if (typeof data === 'string' && data.endsWith('Z')) {
                    return moment.utc(data).local().format('DD-MM-YYYY HH:mm');
                  }
                  return moment(data).format('DD-MM-YYYY HH:mm');
                }
                return data;
              }
            },
            {'data': 'id', 'sName': 'Operations', 'aTargets': [ 4 ],
                'bSortable': false,
                "mRender": function (data, type, full) {
                    var delete_url = "{% url 'keywords:delete_keyword' keywordid=0 %}".replace(0, full.id);
                    return '<div class="btn-group1">' +
                        '<a class="btn btn-xs confirm" rel="tooltip" data-placement="right" data-original-title="Delete Supplier" data-display="'+full.keyword+'" data-href="'+delete_url+'" href="#">' +
                        '<span class="glyphicon glyphicon-trash" aria-hidden="true"></span>' +
                        '</a> ' +
                        '</div>';
                    },
                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                    $("a", nTd).tooltip();
                }
            },
        ]
    });

    // Limit the number of keywords displayed initially
    var $interestingKeywordsList = $('#interesting-keywords-list');
    var $keywords = $interestingKeywordsList.children('li');
    var initialDisplayCount = 20;

    $keywords.slice(initialDisplayCount).hide();

    // Add a "Show More" button if there are more than initialDisplayCount keywords
    if ($keywords.length > initialDisplayCount) {
        $interestingKeywordsList.after('<button id="show-more-keywords" class="btn btn-primary btn-xs">Show More</button>');
    }

    // Show more keywords when the "Show More" button is clicked
    $('#show-more-keywords').on('click', function() {
        $keywords.show();
        $(this).remove();
    });

    // ========== Manage Keywords Modal ==========
    var keywordTypes = [
        { value: 'domaintools_registrant_org', label: 'DomainTools - Registrant Organization' },
        { value: 'domaintools_registrant_email', label: 'DomainTools - Registrant Email' },
        { value: 'domaintools_registrant_email_domain', label: 'DomainTools - Registrant Email Domain' },
        { value: 'crtsh_domain', label: 'CRTSH - Domain' },
        { value: 'shodan_keyword', label: 'Shodan - query keyword' },
        { value: 'porch-pirate_keyword', label: 'Porch-pirate - query keyword' },
        { value: 'swaggerhub_keyword', label: 'SwaggerHub - query keyword' },
        { value: 'ai_scribd_keyword', label: 'ShepherdAI - Scribd search' },
        { value: 'git-hound_keyword', label: 'GitHound - query keyword' },
        { value: 'fofa_keyword', label: 'FOFA - query keyword' },
    ];

    function createKeywordRow(keyword) {
        var isNew = !keyword.id;
        var rowClass = isNew ? 'keyword-editor-row new-keyword-row' : 'keyword-editor-row';
        if (keyword.enabled === false) {
            rowClass += ' disabled-keyword';
        }
        
        var typeOptions = keywordTypes.map(function(t) {
            var selected = (keyword.ktype === t.value) ? 'selected' : '';
            return '<option value="' + t.value + '" ' + selected + '>' + t.label + '</option>';
        }).join('');

        var enabledChecked = (keyword.enabled !== false) ? 'checked' : '';
        
        return '<div class="' + rowClass + '" data-id="' + (keyword.id || 'new-' + Date.now()) + '">' +
            '<input type="text" class="form-control input-sm keyword-value" placeholder="Keyword" value="' + (keyword.keyword || '') + '">' +
            '<select class="form-control input-sm keyword-type">' + typeOptions + '</select>' +
            '<input type="text" class="form-control input-sm keyword-description" placeholder="Description (optional)" value="' + (keyword.description || '') + '" style="flex:1.5;">' +
            '<label style="margin:0; white-space:nowrap;"><input type="checkbox" class="keyword-enabled" ' + enabledChecked + '> Enabled</label>' +
            '<span class="btn-remove glyphicon glyphicon-trash" title="Remove"></span>' +
            '</div>';
    }

    function loadKeywordsIntoEditor() {
        var $list = $('#keyword-editor-list');
        $list.html('<div class="text-center text-muted">Loading keywords...</div>');
        
        $.ajax({
            url: '/api/v1/project/{{ projectid }}/keywords/all/',
            type: 'GET',
            success: function(response) {
                $list.empty();
                var keywords = response.results || response;
                if (keywords.length === 0) {
                    $list.html('<div class="text-center text-muted">No keywords yet. Click "Add Keyword" to create one.</div>');
                } else {
                    // Sort by ID
                    keywords.sort(function(a, b) { return a.id - b.id; });
                    keywords.forEach(function(kw) {
                        $list.append(createKeywordRow(kw));
                    });
                }
            },
            error: function() {
                $list.html('<div class="text-center text-danger">Failed to load keywords.</div>');
            }
        });
    }

    $('#btn-manage-keywords').on('click', function() {
        loadKeywordsIntoEditor();
        $('#keywords-save-status').text('');
        $('#ManageKeywordsModal').modal('show');
    });

    $('#btn-add-keyword-row').on('click', function() {
        var $list = $('#keyword-editor-list');
        // Remove "no keywords" message if present
        $list.find('.text-muted').remove();
        $list.append(createKeywordRow({ ktype: 'domaintools_registrant_org', enabled: true }));
        // Scroll to bottom
        $list.scrollTop($list[0].scrollHeight);
    });

    $(document).on('click', '.btn-remove', function() {
        $(this).closest('.keyword-editor-row').remove();
    });

    $('#btn-save-keywords').on('click', function() {
        var keywords = [];
        var hasError = false;
        
        $('#keyword-editor-list .keyword-editor-row').each(function() {
            var $row = $(this);
            var value = $row.find('.keyword-value').val().trim();
            if (!value) {
                $row.find('.keyword-value').css('border-color', 'red');
                hasError = true;
                return;
            }
            $row.find('.keyword-value').css('border-color', '');
            
            var idAttr = $row.data('id');
            var id = (typeof idAttr === 'string' && idAttr.startsWith('new-')) ? null : idAttr;
            
            keywords.push({
                id: id,
                keyword: value,
                ktype: $row.find('.keyword-type').val(),
                description: $row.find('.keyword-description').val().trim(),
                enabled: $row.find('.keyword-enabled').is(':checked')
            });
        });

        if (hasError) {
            $('#keywords-save-status').text('Please fill in all keyword values.').css('color', 'red');
            return;
        }

        $('#btn-save-keywords').prop('disabled', true).text('Saving...');
        $('#keywords-save-status').text('').css('color', '');

        $.ajax({
            url: '{% url "keywords:bulk_update_keywords" %}',
            type: 'POST',
            contentType: 'application/json',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            data: JSON.stringify({ keywords: keywords }),
            success: function(response) {
                $('#keywords-save-status').text('Saved successfully!').css('color', 'green');
                $('#ManageKeywordsModal').modal('hide');
                // Reload both tables
                keywordsTable.ajax.reload();
                suppliersTable.ajax.reload();
            },
            error: function(xhr) {
                var msg = 'Failed to save.';
                try {
                    var resp = JSON.parse(xhr.responseText);
                    msg = resp.message || msg;
                } catch(e) {}
                $('#keywords-save-status').text(msg).css('color', 'red');
            },
            complete: function() {
                $('#btn-save-keywords').prop('disabled', false).text('Save Changes');
            }
        });
    });

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ========== Upload RansomLook Suppliers Modal ==========
    initializeUploadModal({
        modalId: '#UploadRansomlookSuppliersModal',
        dropZoneId: '#upload-suppliers-drop-zone',
        fileInputId: '#modal-suppliers-file',
        fileInfoId: '#upload-suppliers-file-info',
        fileNameId: '#upload-suppliers-file-name',
        submitBtnId: '#upload-suppliers-submit-btn',
        dropTextId: '#upload-suppliers-drop-text',
        clearBtnId: '#upload-suppliers-clear-file',
        acceptedExtension: '.txt'
    });
});

$(document).on("click", ".confirm", function(e) {
    e.preventDefault();
    var title = $(this).attr('data-display');
    var location = $(this).attr('data-href');
    bootbox.confirm('Are you sure?<br/>(Delete Entry: ' + title + ')', function(confirmed) {
        if(confirmed)
        {
            window.location.replace(location);
        }
    });
});
</script>
{% endblock %}
